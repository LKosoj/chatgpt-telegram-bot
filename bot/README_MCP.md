# Поддержка MCP серверов в Telegram боте

## Что такое MCP сервер?

MCP (Machine Conversation Protocol) сервер - это стандартизированный API-интерфейс, который позволяет добавлять внешние функции-инструменты в чат-бота. MCP серверы предоставляют доступ к различным инструментам (tools) через единый интерфейс, что упрощает интеграцию новых возможностей без необходимости изменения основного кода бота.

## Как это работает

1. **Регистрация MCP сервера**: Бот регистрирует внешний MCP сервер, получая от него список доступных инструментов.
2. **Добавление инструментов**: Инструменты MCP сервера добавляются в список доступных функций бота с префиксом имени сервера.
3. **Вызов функций**: Когда модель ИИ решает использовать инструмент с внешнего сервера, плагин MCP перенаправляет запрос на соответствующий сервер.
4. **Обработка результатов**: Результаты выполнения функции возвращаются модели для формирования ответа пользователю.

## Типы транспорта для MCP серверов

Бот поддерживает два типа транспорта для взаимодействия с MCP серверами:

1. **HTTP транспорт** - классический вариант с использованием REST API. Сервер должен быть доступен по сети через HTTP.
2. **stdio транспорт** - новый тип транспорта, который позволяет запускать MCP серверы как дочерние процессы и взаимодействовать с ними через стандартные потоки ввода/вывода (stdin/stdout). Это удобно для:
   - Локальной разработки без необходимости запуска отдельного веб-сервера
   - Запуска изолированных MCP серверов непосредственно на сервере бота
   - Обеспечения безопасности за счет отсутствия сетевых соединений
   - Интеграции с любыми скриптами или программами, поддерживающими stdio

## Настройка

### Переменные окружения

Добавьте следующие переменные в файл `.env`:

```
# Включение поддержки MCP серверов
ENABLE_MCP_SERVERS=true

# Пользователи, которым разрешено использовать MCP серверы (* для всех)
MCP_SERVERS_ALLOWED_USERS=*

# Серверы по умолчанию в формате имя:url,имя2:url2
DEFAULT_MCP_SERVERS=weather:http://localhost:8080,finance:http://localhost:8081

# Таймаут запросов к MCP серверам в секундах
MCP_REQUEST_TIMEOUT=30
```

### Хранение конфигурации

Конфигурация зарегистрированных MCP серверов сохраняется в файле `bot/config/mcp_servers.json`. Этот файл автоматически создается при регистрации первого сервера и содержит информацию о всех зарегистрированных серверах, включая:

- URL сервера или команду для запуска (в зависимости от типа транспорта)
- API ключи (если используются)
- Описание сервера
- Доступные инструменты

## Использование

### Регистрация HTTP MCP сервера (только для администраторов)

Зарегистрировать новый HTTP MCP сервер может только администратор бота (пользователи, указанные в `ADMIN_USER_IDS` в файле `.env`). Для регистрации используйте команду:

```
Зарегистрируй новый MCP сервер с именем weather_service, URL http://example.com/api и ключом API_KEY_123
```

Или программно через функцию `register_mcp_server`:

```json
{
  "server_name": "weather_service",
  "base_url": "http://example.com/api",
  "api_key": "API_KEY_123",
  "description": "Сервис погоды с глобальным покрытием",
  "user_id": 123456789
}
```

### Регистрация stdio MCP сервера (только для администраторов)

Чтобы зарегистрировать MCP сервер, использующий stdio транспорт, используйте команду:

```
Зарегистрируй MCP сервер с именем calculator, транспорт stdio, команда python, аргументы ["examples/mcp_stdio_server.py"]
```

Или программно через функцию `register_mcp_server`:

```json
{
  "server_name": "calculator",
  "transport": "stdio",
  "command": "python",
  "args": ["examples/mcp_stdio_server.py"],
  "env": {"VAR1": "value1", "VAR2": "value2"},
  "description": "Калькулятор с базовыми математическими функциями",
  "user_id": 123456789
}
```

### Просмотр зарегистрированных серверов

Чтобы увидеть список зарегистрированных MCP серверов, используйте команду `/mcp_servers` или попросите бота:

```
Покажи список всех MCP серверов
```

### Удаление MCP сервера (только для администраторов)

Для удаления сервера администратор может использовать:

```
Удали MCP сервер weather_service
```

Или программно через функцию `remove_mcp_server`:

```json
{
  "server_name": "weather_service",
  "user_id": 123456789
}
```

### Использование инструментов MCP сервера

После регистрации сервера его инструменты автоматически становятся доступными для модели ИИ. Например, для сервера с именем `weather_service` и функцией `get_weather`, модель будет использовать функцию `weather_service_get_weather`.

```
Какая сейчас погода в Москве?
```

Модель может решить использовать `weather_service_get_weather` с параметром `city: "Москва"`.

## Создание собственного MCP сервера

### HTTP MCP сервер

Чтобы создать совместимый HTTP MCP сервер, вам необходимо реализовать следующие эндпоинты:

#### 1. GET /tools

Возвращает список доступных инструментов в формате OpenAI Function Calling:

```json
[
  {
    "name": "get_weather",
    "description": "Получить текущую погоду для указанного города",
    "parameters": {
      "type": "object",
      "properties": {
        "city": {
          "type": "string",
          "description": "Название города для получения погоды"
        }
      },
      "required": ["city"]
    }
  }
]
```

#### 2. POST /execute

Эндпоинт для выполнения вызовов функций. Принимает запрос в формате:

```json
{
  "name": "get_weather",
  "arguments": {
    "city": "Москва"
  }
}
```

И возвращает результат выполнения в JSON формате.

### stdio MCP сервер

Для создания stdio MCP сервера используйте официальную библиотеку MCP:

```bash
pip install mcp
```

Пример простого stdio MCP сервера:

```python
from mcp.server.fastmcp import FastMCP
import logging

# Настройка логирования
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Создаем экземпляр MCP сервера
mcp = FastMCP("Example MCP Server")

# Определяем инструменты
@mcp.tool()
def add(a: int, b: int) -> int:
    """
    Складывает два числа
    
    :param a: Первое число
    :param b: Второе число
    :return: Сумма двух чисел
    """
    logger.info(f"Вызвана функция add с параметрами: a={a}, b={b}")
    return a + b

@mcp.tool()
def greeting(name: str) -> str:
    """
    Возвращает приветственное сообщение
    
    :param name: Имя пользователя
    :return: Приветственное сообщение
    """
    return f"Привет, {name}!"

if __name__ == "__main__":
    # Запускаем сервер с stdio транспортом
    mcp.run(transport="stdio")
```

## Безопасность

### Авторизация запросов

Рекомендуется использовать API ключи для авторизации запросов к HTTP MCP серверам. Плагин автоматически добавляет заголовок `Authorization: Bearer API_KEY` к запросам, если API ключ указан при регистрации сервера.

Для stdio MCP серверов дополнительная авторизация обычно не требуется, так как они запускаются как дочерние процессы и могут наследовать переменные окружения от родительского процесса.

### Ограничение доступа

- Регистрация и удаление MCP серверов доступны только администраторам бота (пользователям, указанным в ADMIN_USER_IDS)
- Использование инструментов MCP серверов доступно всем пользователям, если не указано иное в MCP_SERVERS_ALLOWED_USERS

## Примеры MCP серверов

### HTTP MCP сервер
В файле `mcp_server_example.py` представлен рабочий пример HTTP MCP сервера, который можно использовать как основу для создания собственных сервисов. Пример включает функции получения погоды, конвертации валют и генерации уникальных идентификаторов.

Для запуска примера сервера выполните:

```bash
pip install fastapi uvicorn
python mcp_server_example.py
```

После запуска сервер будет доступен по адресу `http://localhost:8080`.

### stdio MCP сервер
В директории `examples` содержатся примеры stdio MCP серверов и клиентов:

- `mcp_stdio_server.py` - пример MCP сервера с stdio транспортом
- `mcp_stdio_client.py` - пример клиента, подключающегося к MCP серверу через stdio

Для запуска примера stdio сервера запустите клиент:

```bash
python examples/mcp_stdio_client.py
```

## Преимущества использования MCP серверов

1. **Модульность**: Легко добавлять новые функции без изменения кода бота
2. **Масштабируемость**: Можно распределить нагрузку на отдельные серверы
3. **Безопасность**: Изоляция выполняемого кода
4. **Повторное использование**: Один MCP сервер может использоваться несколькими ботами
5. **Независимое обновление**: Обновление функциональности без перезапуска бота
6. **Гибкие варианты размещения**: HTTP для распределенной архитектуры, stdio для локального выполнения

## Ограничения

### HTTP транспорт
- HTTP MCP серверы должны быть доступны из сети, где работает бот
- Для обеспечения безопасности рекомендуется использовать API ключи
- Производительность зависит от скорости соединения с внешними серверами

### stdio транспорт
- stdio MCP серверы запускаются как отдельные процессы на том же сервере, где работает бот
- Необходимо управлять жизненным циклом дочерних процессов
- При закрытии соединения процесс сервера автоматически завершается 