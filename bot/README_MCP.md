# Поддержка MCP серверов в Telegram боте

## Что такое MCP сервер?

MCP (Machine Conversation Protocol) сервер - это стандартизированный API-интерфейс, который позволяет добавлять внешние функции-инструменты в чат-бота. MCP серверы предоставляют доступ к различным инструментам (tools) через единый интерфейс, что упрощает интеграцию новых возможностей без необходимости изменения основного кода бота.

## Как это работает

1. **Регистрация MCP сервера**: Бот регистрирует внешний MCP сервер, получая от него список доступных инструментов.
2. **Добавление инструментов**: Инструменты MCP сервера добавляются в список доступных функций бота с префиксом имени сервера.
3. **Вызов функций**: Когда модель ИИ решает использовать инструмент с внешнего сервера, плагин MCP перенаправляет запрос на соответствующий сервер.
4. **Обработка результатов**: Результаты выполнения функции возвращаются модели для формирования ответа пользователю.

## Настройка

### Переменные окружения

Добавьте следующие переменные в файл `.env`:

```
# Включение поддержки MCP серверов
ENABLE_MCP_SERVERS=true

# Пользователи, которым разрешено использовать MCP серверы (* для всех)
MCP_SERVERS_ALLOWED_USERS=*

# Серверы по умолчанию в формате имя:url,имя2:url2
DEFAULT_MCP_SERVERS=weather:http://localhost:8080,finance:http://localhost:8081

# Таймаут запросов к MCP серверам в секундах
MCP_REQUEST_TIMEOUT=30
```

### Хранение конфигурации

Конфигурация зарегистрированных MCP серверов сохраняется в файле `bot/config/mcp_servers.json`. Этот файл автоматически создается при регистрации первого сервера и содержит информацию о всех зарегистрированных серверах, включая:

- URL сервера
- API ключи (если используются)
- Описание сервера
- Доступные инструменты

## Использование

### Регистрация MCP сервера (только для администраторов)

Зарегистрировать новый MCP сервер может только администратор бота (пользователи, указанные в `ADMIN_USER_IDS` в файле `.env`). Для регистрации используйте команду:

```
Зарегистрируй новый MCP сервер с именем weather_service, URL http://example.com/api и ключом API_KEY_123
```

Или программно через функцию `register_mcp_server`:

```json
{
  "server_name": "weather_service",
  "base_url": "http://example.com/api",
  "api_key": "API_KEY_123",
  "description": "Сервис погоды с глобальным покрытием",
  "user_id": 123456789
}
```

### Просмотр зарегистрированных серверов

Чтобы увидеть список зарегистрированных MCP серверов, используйте команду `/mcp_servers` или попросите бота:

```
Покажи список всех MCP серверов
```

### Удаление MCP сервера (только для администраторов)

Для удаления сервера администратор может использовать:

```
Удали MCP сервер weather_service
```

Или программно через функцию `remove_mcp_server`:

```json
{
  "server_name": "weather_service",
  "user_id": 123456789
}
```

### Использование инструментов MCP сервера

После регистрации сервера его инструменты автоматически становятся доступными для модели ИИ. Например, для сервера с именем `weather_service` и функцией `get_weather`, модель будет использовать функцию `weather_service_get_weather`.

```
Какая сейчас погода в Москве?
```

Модель может решить использовать `weather_service_get_weather` с параметром `city: "Москва"`.

## Создание собственного MCP сервера

Чтобы создать совместимый MCP сервер, вам необходимо реализовать следующие эндпоинты:

### 1. GET /tools

Возвращает список доступных инструментов в формате OpenAI Function Calling:

```json
[
  {
    "name": "get_weather",
    "description": "Получить текущую погоду для указанного города",
    "parameters": {
      "type": "object",
      "properties": {
        "city": {
          "type": "string",
          "description": "Название города для получения погоды"
        }
      },
      "required": ["city"]
    }
  }
]
```

### 2. POST /execute

Эндпоинт для выполнения вызовов функций. Принимает запрос в формате:

```json
{
  "name": "get_weather",
  "arguments": {
    "city": "Москва"
  }
}
```

И возвращает результат выполнения в JSON формате.

## Безопасность

### Авторизация запросов

Рекомендуется использовать API ключи для авторизации запросов к MCP серверам. Плагин автоматически добавляет заголовок `Authorization: Bearer API_KEY` к запросам, если API ключ указан при регистрации сервера.

### Ограничение доступа

- Регистрация и удаление MCP серверов доступны только администраторам бота (пользователям, указанным в ADMIN_USER_IDS)
- Использование инструментов MCP серверов доступно всем пользователям, если не указано иное в MCP_SERVERS_ALLOWED_USERS

## Пример MCP сервера

В файле `mcp_server_example.py` представлен рабочий пример MCP сервера, который можно использовать как основу для создания собственных сервисов. Пример включает функции получения погоды, конвертации валют и генерации уникальных идентификаторов.

Для запуска примера сервера выполните:

```bash
pip install fastapi uvicorn
python mcp_server_example.py
```

После запуска сервер будет доступен по адресу `http://localhost:8080`.

## Преимущества использования MCP серверов

1. **Модульность**: Легко добавлять новые функции без изменения кода бота
2. **Масштабируемость**: Можно распределить нагрузку на отдельные серверы
3. **Безопасность**: Изоляция выполняемого кода
4. **Повторное использование**: Один MCP сервер может использоваться несколькими ботами
5. **Независимое обновление**: Обновление функциональности без перезапуска бота

## Ограничения

- MCP серверы должны быть доступны из сети, где работает бот
- Для обеспечения безопасности рекомендуется использовать API ключи
- Производительность зависит от скорости соединения с внешними серверами 