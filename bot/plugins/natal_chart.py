import swisseph as swe
from datetime import datetime
from typing import Dict, Any
import math
import logging
from plugins.plugin import Plugin

# Загрузка эфемерид
swe.set_ephe_path('.')  # Укажите путь к файлам эфемерид, если требуется

# Планеты и точки
PLANETS = [
    ("Солнце", swe.SUN),
    ("Луна", swe.MOON),
    ("Меркурий", swe.MERCURY),
    ("Венера", swe.VENUS),
    ("Марс", swe.MARS),
    ("Юпитер", swe.JUPITER),
    ("Сатурн", swe.SATURN),
    ("Уран", swe.URANUS),
    ("Нептун", swe.NEPTUNE),
    ("Плутон", swe.PLUTO),
    ("Северный узел", swe.MEAN_NODE),
    ("Лилит (Черная Луна)", swe.OSCU_APOG),
]

# Основные аспекты
ASPECTS = {
    "соединение": 0,
    "оппозиция": 180,
    "тригон": 120,
    "квадрат": 90,
    "секстиль": 60,
}

ORBS = {
    "соединение": 10,
    "оппозиция": 8,
    "тригон": 8,
    "квадрат": 8,
    "секстиль": 6,
}

ZODIAC_SIGNS = [
    "Овен", "Телец", "Близнецы", "Рак", "Лев", "Дева",
    "Весы", "Скорпион", "Стрелец", "Козерог", "Водолей", "Рыбы"
]

HOUSE_INTERPRETATIONS = {
    1: "Личность, внешний вид, самовыражение.",
    2: "Деньги, ценности, материальная стабильность.",
    3: "Общение, обучение, близкие родственники.",
    4: "Дом, семья, корни, внутренний мир.",
    5: "Творчество, любовь, дети, увлечения.",
    6: "Работа, здоровье, повседневные обязанности.",
    7: "Партнерство, брак, открытые враги.",
    8: "Смерть, трансформация, чужие деньги.",
    9: "Путешествия, философия, высшее образование.",
    10: "Карьера, амбиции, репутация.",
    11: "Друзья, коллективы, мечты.",
    12: "Тайны, изоляция, духовность.",
}

PLANET_SIGN_INTERPRETATIONS = {
    "Солнце": {
        "Овен": "Вы стремитесь к лидерству и действуете решительно.",
        "Телец": "Вы стабильны, цените комфорт и материальные блага.",
        "Близнецы": "Интеллектуальность и общительность — ваши сильные стороны.",
        "Рак": "Вы чувствительны и заботливы, цените семейные традиции.",
        "Лев": "Вы творческий человек, который любит быть в центре внимания.",
        "Дева": "Практичность и внимание к деталям — основа вашей жизни.",
        "Весы": "Гармония и баланс — ваши жизненные ценности.",
        "Скорпион": "Вы страстны, глубокие эмоции движут вами.",
        "Стрелец": "Вы любите свободу, путешествия и новые знания.",
        "Козерог": "Амбициозность и ответственность — ваши сильные черты.",
        "Водолей": "Вы оригинальны, стремитесь к инновациям.",
        "Рыбы": "Вы мечтательны и интуитивны, склонны к духовности.",
    },
    "Луна": {
        "Овен": "Эмоции быстро вспыхивают и так же быстро гаснут, вы импульсивны.",
        "Телец": "Вы эмоционально стабильны, цените комфорт и безопасность.",
        "Близнецы": "Эмоциональная гибкость, быстрые перемены настроений.",
        "Рак": "Очень чувствительная, склонная к сильным привязанностям и заботе.",
        "Лев": "Эмоциональная потребность в признании и уважении.",
        "Дева": "Эмоции часто скрыты, вы предпочитаете практичный подход к жизни.",
        "Весы": "Стремитесь к гармонии в отношениях, очень ориентированы на партнеров.",
        "Скорпион": "Интенсивные эмоции, скрытые чувства, потребность в глубоком эмоциональном соединении.",
        "Стрелец": "Склонны к оптимизму и приключениям, всегда ищете новые горизонты.",
        "Козерог": "Эмоции выражаются сдержанно, важна стабильность и долгосрочные цели.",
        "Водолей": "Эмоции часто кажутся абстрактными, вы склонны к интеллектуальной активности.",
        "Рыбы": "Чувствительность, интуитивность, стремление к эмоциональной поддержке и состраданию.",
    },
    "Меркурий": {
        "Овен": "Быстрое мышление и принятие решений, склонность к прямолинейности.",
        "Телец": "Практичность в мыслях, предпочитаете обдумывать всё тщательно.",
        "Близнецы": "Острый ум, отличная способность к обучению и коммуникации.",
        "Рак": "Чувствительное восприятие, часто реагируете на эмоции окружающих.",
        "Лев": "Творческий подход к решению проблем, уверенность в своих словах.",
        "Дева": "Логическое, структурированное мышление, внимание к деталям.",
        "Весы": "Стремление к балансу и справедливости, хорошо чувствуете другие точки зрения.",
        "Скорпион": "Глубокий, исследовательский ум, стремление к знаниям, которые могут быть скрытыми.",
        "Стрелец": "Мышление ориентировано на перспективу, философские вопросы и глобальные идеи.",
        "Козерог": "Практичное и осторожное мышление, склонность к планированию и долгосрочному видению.",
        "Водолей": "Оригинальность мышления, склонность к новаторству и независимости.",
        "Рыбы": "Интуитивное восприятие, часто принимаете решения, полагаясь на чувства.",
    },
    "Венера": {
        "Овен": "Стремление к страстной любви, импульсивность в отношениях.",
        "Телец": "Стремление к стабильным и комфортным отношениям, чувственность.",
        "Близнецы": "Интеллектуальная любовь, коммуникабельность и разнообразие в отношениях.",
        "Рак": "Забота и эмоциональная привязанность, желание создать гармонию в семье.",
        "Лев": "Поиск любви и признания, стремление к ярким и драматичным отношениям.",
        "Дева": "Любовь через заботу и практическую помощь, внимание к деталям в отношениях.",
        "Весы": "Любовь к гармонии и эстетике, стремление к равноправию в отношениях.",
        "Скорпион": "Глубокие, интенсивные отношения, желание страсти и настоящей близости.",
        "Стрелец": "Любовь к свободе и приключениям, поиски партнера с аналогичными интересами.",
        "Козерог": "Предпочтение серьезных и стабильных отношений, любовь через ответственность.",
        "Водолей": "Оригинальные и нестандартные отношения, склонность к интеллектуальной связи.",
        "Рыбы": "Романтичность, идеализация партнера, желание объединить душевную и духовную связь.",
    },
    "Марс": {
        "Овен": "Энергия, решительность, стремление к лидерству и действию.",
        "Телец": "Неспешный, но упорный подход к действиям, стремление к стабильности.",
        "Близнецы": "Скорость и гибкость в действиях, многозадачность.",
        "Рак": "Защита семьи и близких, эмоциональные действия, склонность к защите своих.",
        "Лев": "Стремление к лидерству, энергия для самовыражения и творчества.",
        "Дева": "Активность через помощь и улучшение, внимание к деталям и организации.",
        "Весы": "Действия через партнерство, стремление к справедливости и гармонии.",
        "Скорпион": "Интенсивность и решительность в действиях, склонность к глубоким и скрытым поступкам.",
        "Стрелец": "Энергия для путешествий, исследований и поиска новых горизонтов.",
        "Козерог": "Стремление к достижению целей через упорный труд и долгосрочные планы.",
        "Водолей": "Действия, основанные на идеях и инновациях, стремление к независимости.",
        "Рыбы": "Действия, вдохновленные интуицией и состраданием, желание помочь другим.",
    },
    "Юпитер": {
        "Овен": "Стремление к успеху, растущий оптимизм и вера в себя.",
        "Телец": "Стабильное расширение благосостояния, ориентация на материальные ценности.",
        "Близнецы": "Любовь к знаниям, расширение через общение и обучение.",
        "Рак": "Оптимизм в семье и отношениях, стремление к духовной и материальной безопасности.",
        "Лев": "Стремление к признанию, философский подход к вопросам саморазвития.",
        "Дева": "Интеллектуальный рост через практическое применение знаний и помощи другим.",
        "Весы": "Рост через партнерство и стремление к справедливости.",
        "Скорпион": "Глубокое расширение через трансформацию, поиск истинного смысла жизни.",
        "Стрелец": "Расширение через путешествия, философию и стремление к большему пониманию мира.",
        "Козерог": "Рост через долгосрочную цель, настойчивость и упорный труд.",
        "Водолей": "Расширение через нестандартные идеи, инновации и идеализм.",
        "Рыбы": "Расширение через интуицию, духовность и помощь другим.",
    },
    "Сатурн": {
        "Овен": "Трудности преодолеваются через решительность, но могут быть проблемы с терпением.",
        "Телец": "Необходимость стабильности, трудности в принятии изменений.",
        "Близнецы": "Проблемы с концентрацией, но способности к адаптации и обучению.",
        "Рак": "Стремление к безопасности, но могут быть проблемы с эмоциональной открытостью.",
        "Лев": "Испытания через выражение себя, желание признания, которое требует усилий.",
        "Дева": "Трудности через необходимость идеала, стремление к перфекционизму.",
        "Весы": "Проблемы с балансом в отношениях, испытания через партнерство.",
        "Скорпион": "Трудности с контролем эмоций, но способность к глубокой трансформации.",
        "Стрелец": "Испытания через расширение горизонтов, ограниченность в практике и дисциплине.",
        "Козерог": "Трудности и препятствия являются частью вашего пути к успеху, учат терпению и дисциплине.",
        "Водолей": "Испытания через нестандартность, со временем вы учитесь быть более самостоятельными.",
        "Рыбы": "Трудности с ясностью целей, но развитие через интуицию и сострадание.",
    },
    "Уран": {
        "Овен": "Вы можете быть очень независимыми и готовы идти на риск ради перемен.",
        "Телец": "Стремление к изменениям в материальном мире, но при этом желание стабильности.",
        "Близнецы": "Инновационные идеи, стремление к свободному мышлению и переменам.",
        "Рак": "Стремление к переменам в семье и эмоциональной жизни, могут быть нестабильные эмоции.",
        "Лев": "Вы оригинальны и стремитесь выражать свою индивидуальность через уникальные формы творчества.",
        "Дева": "Стремление к нестандартным методам в работе, желание модернизировать привычные подходы.",
        "Весы": "Вы ищете перемены в отношениях и стремитесь к инновационным идеям в партнерстве.",
        "Скорпион": "Вы обладаете глубоким и трансформирующим взглядом на жизнь, стремитесь к переменам через интенсивные переживания.",
        "Стрелец": "Любовь к свободе и независимости, поиск нестандартных путей для расширения горизонтов.",
        "Козерог": "Требования перемен и инноваций в карьерных и профессиональных вопросах.",
        "Водолей": "Вы стремитесь к свободе, инновациям и улучшению общества через прогрессивные идеи.",
        "Рыбы": "Нестандартные пути в поисках духовного роста, стремление к переменам через интуицию и идеализм.",
    },
    "Нептун": {
        "Овен": "Стремление к духовным поискам, желание сделать мир лучше, но возможно путаница в целях.",
        "Телец": "Ваши мечты связаны с комфортом и материальной стабильностью, возможно, не хватает четкости.",
        "Близнецы": "Мечтательность и желание развиваться через коммуникацию, но часто трудно сконцентрироваться.",
        "Рак": "Интуитивное восприятие, склонность к глубоким эмоциям, можете быть очень уязвимы.",
        "Лев": "Стремление к высокому идеалу любви и признания, могут быть иллюзии по поводу себя.",
        "Дева": "Мечты, связанные с помощью другим и служением, но часто трудно отделить реальность от фантазий.",
        "Весы": "Тонкая чувственность и стремление к гармонии, но могут быть неясности в отношениях.",
        "Скорпион": "Глубокие эмоциональные переживания, способность к трансформации через духовность и интуицию.",
        "Стрелец": "Стремление к идеалам свободы и философии, иногда сложно держать ноги на земле.",
        "Козерог": "Трудности с реализмом в карьерных и материальных вопросах, но сильная интуиция в долгосрочной перспективе.",
        "Водолей": "Мечты о будущем и поиски смысла через коллективные и идеалистические цели.",
        "Рыбы": "Глубокая связь с интуицией и духовным миром, склонность к самоотдаче и идеалистическим переживаниям.",
    },
    "Плутон": {
        "Овен": "Трансформация через активное лидерство и индивидуальные действия.",
        "Телец": "Глубокие изменения в материальном мире, способность к трансформации через ценности.",
        "Близнецы": "Интенсивные перемены через коммуникацию, глубокие исследования и поиск истины.",
        "Рак": "Трансформация семейных и эмоциональных структур, глубокие переживания.",
        "Лев": "Трансформация через самовыражение и стремление быть в центре внимания.",
        "Дева": "Изменения через работу и здоровье, способность к восстановлению через практическую жизнь.",
        "Весы": "Трансформация в отношениях, поиск глубоких и значимых партнерств.",
        "Скорпион": "Интенсивность, трансформация и восстановление через глубокие внутренние процессы.",
        "Стрелец": "Трансформация через личный рост, путешествия и философию.",
        "Козерог": "Глубокие изменения в карьерных и социальных структурах, устойчивость и долгосрочная трансформация.",
        "Водолей": "Трансформация через идеологию и стремление к улучшению общества.",
        "Рыбы": "Глубокая духовная трансформация, возможность исцеления через самоотдачу и интуицию.",
    },
    "Северный узел": {
        "Овен": "Ваш путь — это личное утверждение, независимость и стремление к лидерству.",
        "Телец": "Уроки жизни заключаются в поиске стабильности, построении материальных и эмоциональных основ.",
        "Близнецы": "Вы учитесь через коммуникацию, обмен знаниями и идеями.",
        "Рак": "Ваша миссия — это создание гармоничных и стабильных отношений, особенно в семейной жизни.",
        "Лев": "Ваша задача — раскрывать свою индивидуальность, стремиться к признанию и выражению себя.",
        "Дева": "Вы учитесь через практичность, служение и внимание к деталям.",
        "Весы": "Ваш путь — это развитие гармоничных партнерств и отношений.",
        "Скорпион": "Ваша жизнь — это глубокие перемены и трансформации через интимные связи.",
        "Стрелец": "Вы учитесь расширять горизонты, исследовать и стремиться к духовному росту.",
        "Козерог": "Уроки жизни через карьеры, амбиции и преодоление трудностей на пути к успеху.",
        "Водолей": "Ваш путь — это инновации, изменения в обществе и стремление к прогрессу.",
        "Рыбы": "Ваша миссия — это духовный рост, сострадание и помощь другим.",
    },
    "Лилит (Черная Луна)": {
        "Овен": "Страх потерпеть неудачу или быть отвергнутым, страх перед конфликтами. Вы можете избегать проявлений агрессии и прямых действий, что порой блокирует ваш потенциал.",
        "Телец": "Страх потери материальных благ, стремление к безопасности любой ценой. Вы можете избегать изменений, бояться потерять стабильность и комфорт.",
        "Близнецы": "Трудности в самовыражении, страх быть непонятым или недостаточно умным. Может возникать внутренняя борьба между желанием общаться и страхом быть отвергнутым.",
        "Рак": "Страх отвержения со стороны семьи или близких людей, желание защиты и безопасности. Вы можете быть склонны скрывать свои истинные чувства и нужды, чтобы избежать конфликтов.",
        "Лев": "Страх быть незамеченным или непризнанным, страх за свою индивидуальность. Это может проявляться в стремлении к чрезмерному вниманию и признанию.",
        "Дева": "Страх несовершенства, боязнь не соответствовать стандартам. Вы можете слишком критично относиться к себе и другим, пытаясь достичь идеала.",
        "Весы": "Страх одиночества и социальной изоляции, беспокойство о своем имидже в обществе. Вы можете бояться конфликтов в отношениях и избегать их решения.",
        "Скорпион": "Страх быть уязвимым и открытым для других, склонность к скрытности и манипуляциям. Вам может быть трудно доверять другим, что приводит к внутренним конфликтам.",
        "Стрелец": "Страх быть ограниченным в свободе или невозможности следовать своим идеалам. Вы можете избегать обязательств и ответственности ради сохранения своей независимости.",
        "Козерог": "Страх не оправдать ожиданий, особенно в профессиональной сфере. Вы можете скрывать свои истинные эмоции и уязвимости ради внешнего успеха.",
        "Водолей": "Страх потерять свою уникальность или быть слишком обремененным социальными нормами. Вы можете избегать общепринятых структур и авторитетов, стремясь к индивидуализму.",
        "Рыбы": "Страх утопить свои мечты в реальности, склонность к самообману или избеганию трудных ситуаций. Вы можете бояться, что ваши идеалы никогда не будут реализованы, и склонны к самосожалению.",
    }
}

ASPECT_INTERPRETATIONS = {
    "соединение": "Сильное слияние энергий, подчеркивающее их влияние.",
    "оппозиция": "Конфликт или напряжение, требующее поиска баланса.",
    "тригон": "Гармония и легкость в проявлении энергий.",
    "квадрат": "Трудности и вызовы, которые стимулируют рост.",
    "секстиль": "Благоприятные возможности при активных действиях.",
}

class NatalCardPlugin(Plugin):
    """
    Плагин для вычисления натальной карты
    """

    def get_source_name(self) -> str:
        return "Prompt Perfect"

    def get_spec(self) -> [Dict]:
        latitude_param = {"type": "string", "description": "Широта места рождения"}
        longitude_param = {"type": "string", "description": "Долгота места рождения"}
        return [{
            "name": "natal_cart",
            "description": "Расчитывает натальную карту по введенной дате и месте рождения",
            "parameters": {
                "type": "object",
                "properties": {
                    "date": {
                        "type": "string",
                        "description": "Дата рождения в формате DD-MM-YYYY  HH:MM"
                    },
                    "latitude": latitude_param,
                    "longitude": longitude_param,
                },
                "required": ["date", "latitude", "longitude"]
            }
        }]

    async def execute(self, function_name, helper, **kwargs) -> Dict:
        try:
            date = kwargs.get('date', '')
            latitude = kwargs.get('latitude', '')
            longitude = kwargs.get('longitude', '')
            return await self.calculate_detailed_natal_chart(date, latitude, longitude)
        except Exception as e:
            logging.error(f"Error in Prompt Perfect plugin: {e}")
            return {
                "error": str(e)
            }

        except Exception as e:
            logging.error(f"Error in Prompt Perfect plugin: {e}")
            return {
                "error": str(e)
            }

    def get_zodiac_sign(self, degree):
        """Возвращает знак зодиака по градусу эклиптики."""
        try:
            # Handle tuple/list input
            if isinstance(degree, (tuple, list)):
                degree = float(degree[0])  # Get longitude from tuple
            else:
                degree = float(degree)
            
            # Normalize the degree to be within 0-360
            degree = degree % 360
            
            # Calculate the zodiac sign index (0-11)
            index = int(degree // 30)
            
            return ZODIAC_SIGNS[index]
        except Exception as e:
            logging.error(f"Error getting zodiac sign for degree {degree}: {e}")
            return "Неизвестный знак"

    def calculate_aspects(self, planet_positions):
        """Вычисляет аспекты между планетами."""
        aspects = []
        planet_list = list(planet_positions.items())

        def get_position_value(pos):
            """Helper function to extract longitude value from position data"""
            if isinstance(pos, (tuple, list)):
                return float(pos[0])  # Get longitude from tuple
            return float(pos)  # Already a number

        for i, (planet1, pos1) in enumerate(planet_list):
            for planet2, pos2 in planet_list[i + 1:]:
                try:
                    # Convert positions to float values
                    pos1_value = get_position_value(pos1)
                    pos2_value = get_position_value(pos2)
                    
                    # Calculate angle between planets
                    angle = abs(pos1_value - pos2_value)
                    angle = 360 - angle if angle > 180 else angle

                    # Check for aspects
                    for aspect_name, aspect_angle in ASPECTS.items():
                        if abs(angle - aspect_angle) <= ORBS[aspect_name]:
                            interpretation = ASPECT_INTERPRETATIONS.get(aspect_name, "Нет данных")
                            aspects.append(f"{planet1} и {planet2}: {aspect_name} ({angle:.2f}°). {interpretation}")
                except Exception as e:
                    logging.error(f"Error calculating aspect between {planet1} and {planet2}: {e}")
                    continue

        return aspects

    def calculate_houses(self, jd, latitude, longitude):
        """Рассчитывает дома и возвращает интерпретацию."""
        try:
            houses, cusps = swe.houses(jd, float(latitude), float(longitude), b'P')
            result = []

            for i, cusp in enumerate(cusps, 1):
                if i <= 12:  # Only process the 12 houses
                    sign = self.get_zodiac_sign(float(cusp))
                    interpretation = HOUSE_INTERPRETATIONS.get(i, "Нет данных")
                    result.append(f"Дом {i} ({sign}): {interpretation}")

            return result
        except Exception as e:
            logging.error(f"Error calculating houses: {e}")
            return [f"Ошибка при расчете домов: {str(e)}"]
    
    def interpret_planet_in_sign(self, planet, degree):
        """Возвращает интерпретацию планеты в знаке."""
        sign = self.get_zodiac_sign(degree)
        interpretation = PLANET_SIGN_INTERPRETATIONS.get(planet, {}).get(sign, "Нет данных.")
        return f"{planet} в знаке {sign}: {interpretation}"

    async def calculate_detailed_natal_chart(self, birth_datetime_str, latitude, longitude):
        """Полный расчет натальной карты с интерпретацией."""
        try:
            birth_datetime = datetime.strptime(f"{birth_datetime_str}", "%d-%m-%Y %H:%M")
            jd = swe.julday(birth_datetime.year, birth_datetime.month, birth_datetime.day, 
                            birth_datetime.hour + birth_datetime.minute / 60)

            result = ["🌌 **Ваша натальная карта:**\n"]

            # Расчет позиций планет
            planet_positions = {}
            for planet_name, planet_id in PLANETS:
                planet_data, _  = swe.calc_ut(jd, planet_id)
                    
                # Extract longitude from the returned data array
                planet_position = planet_data[0] if isinstance(planet_data, (list, tuple)) else planet_data

                planet_positions[planet_name] = planet_position

                # Интерпретация планет в знаках
                logging.info(f'planet_name = {planet_name} planet_position = {planet_position}')
                interpretation = self.interpret_planet_in_sign(planet_name, planet_position)
                if interpretation:
                    result.append(interpretation)

            # Расчет домов
            result.append("\n🏠 **Дома:**")
            try:
                house_interpretations = self.calculate_houses(jd, float(latitude), float(longitude))
                result.extend(house_interpretations)
            except Exception as e:
                logging.error(f"Error calculating houses: {e}")
                result.append("Ошибка при расчете домов")

            # Аспекты
            result.append("\n✨ **Аспекты:**")
            try:
                aspects = self.calculate_aspects(planet_positions)
                result.extend(aspects)
            except Exception as e:
                logging.error(f"Error calculating aspects: {e}")
                result.append("Ошибка при расчете аспектов")

            return result

        except Exception as e:
            error_msg = f"Ошибка при расчете натальной карты: {str(e)}"
            logging.error(error_msg)
            return [error_msg]
